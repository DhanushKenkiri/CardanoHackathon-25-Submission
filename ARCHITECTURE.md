# ðŸ—ï¸ ParknGo - System Architecture Documentation

> Detailed technical architecture for Cardano AI Hackathon 2025

---

## ðŸ“‹ Table of Contents

- [System Overview](#system-overview)
- [Component Architecture](#component-architecture)
- [Data Flow Diagrams](#data-flow-diagrams)
- [Agent Orchestration](#agent-orchestration)
- [Blockchain Integration](#blockchain-integration)
- [Database Schema](#database-schema)
- [API Architecture](#api-architecture)
- [Security Architecture](#security-architecture)
- [Deployment Architecture](#deployment-architecture)

---

## ðŸŒ System Overview

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  React Dashboard (Port 8080)                                     â”‚ â”‚
â”‚  â”‚  â€¢ Vite Dev Server                                               â”‚ â”‚
â”‚  â”‚  â€¢ shadcn/ui Components                                          â”‚ â”‚
â”‚  â”‚  â€¢ Framer Motion Animations                                      â”‚ â”‚
â”‚  â”‚  â€¢ Real-time Polling (2s interval)                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ REST API (HTTP/JSON)
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       APPLICATION LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Flask Backend (Port 5000) - Docker Container                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  ORCHESTRATOR AGENT (Master Coordinator)                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Workflow Management                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Gate Check Logic                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Gemini AI Integration                                   â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚               â”‚            â”‚            â”‚                        â”‚ â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚    â”‚ SpotFinder    â”‚ â”‚ Vehicle  â”‚ â”‚  Payment     â”‚ â”‚ Other  â”‚â”‚ â”‚
â”‚  â”‚    â”‚ Agent (0.3â‚³)  â”‚ â”‚ Detector â”‚ â”‚  Agent (0.4â‚³)â”‚ â”‚ Agents â”‚â”‚ â”‚
â”‚  â”‚    â”‚               â”‚ â”‚ (0.2â‚³)   â”‚ â”‚              â”‚ â”‚        â”‚â”‚ â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MASUMI LAYER    â”‚  â”‚   DATA LAYER     â”‚  â”‚  AI/ML LAYER       â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                    â”‚
â”‚ Registry (3000)  â”‚  â”‚ Firebase RTDB    â”‚  â”‚ Google Gemini API  â”‚
â”‚ Payment (3001)   â”‚  â”‚ PostgreSQL (Ã—2)  â”‚  â”‚ â€¢ Agent Reasoning  â”‚
â”‚ Postgres DBs     â”‚  â”‚ â€¢ Parking Data   â”‚  â”‚ â€¢ Dispute AI       â”‚
â”‚                  â”‚  â”‚ â€¢ Payment Logs   â”‚  â”‚ â€¢ Fraud Detection  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  BLOCKCHAIN LAYER     â”‚
                    â”‚                       â”‚
                    â”‚  Cardano Preprod      â”‚
                    â”‚  via Blockfrost API   â”‚
                    â”‚  â€¢ TX Submission      â”‚
                    â”‚  â€¢ Verification       â”‚
                    â”‚  â€¢ On-chain Tracking  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRESENTATION LAYER                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ React 18.3.1 â”‚ TypeScript â”‚ Vite 5.4.19 â”‚ Tailwind CSS    â”‚
â”‚ shadcn/ui â”‚ Framer Motion â”‚ React Router â”‚ Lucide Icons    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APPLICATION LAYER                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Flask 3.0.0 â”‚ Python 3.11 â”‚ Gunicorn â”‚ Flask-CORS         â”‚
â”‚ 7 AI Agents (Gemini) â”‚ PyCardano â”‚ Firebase Admin SDK     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE LAYER                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Masumi Registry (Node.js) â”‚ Masumi Payment (Node.js)       â”‚
â”‚ Firebase RTDB â”‚ Google Gemini API â”‚ Blockfrost API         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATA LAYER                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PostgreSQL 15 (Ã—2) â”‚ Firebase Realtime DB â”‚ Docker Volumes â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INFRASTRUCTURE LAYER                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Docker â”‚ Docker Compose â”‚ Cardano Blockchain (Preprod)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ§© Component Architecture

### Frontend Components

```
hackathon-main/src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ LandingPage.tsx (459 lines)
â”‚   â”‚   â”œâ”€â”€ Hero Section
â”‚   â”‚   â”œâ”€â”€ System Architecture Diagram
â”‚   â”‚   â”œâ”€â”€ Agent Flow Visualization
â”‚   â”‚   â””â”€â”€ 7 Agents Breakdown
â”‚   â”‚
â”‚   â””â”€â”€ Dashboard.tsx (751 lines)
â”‚       â”œâ”€â”€ Header (Wallet Balance)
â”‚       â”œâ”€â”€ Tabs (Overview/Booking/History/Disputes)
â”‚       â”œâ”€â”€ Book Slot Button
â”‚       â””â”€â”€ Modal Management
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ BookSlotOrchestration.tsx (420 lines)
â”‚   â”‚   â”œâ”€â”€ 3-Step Progress Indicator
â”‚   â”‚   â”œâ”€â”€ Real-time Status Updates
â”‚   â”‚   â”œâ”€â”€ Live Payment Session Tracker
â”‚   â”‚   â”œâ”€â”€ Progress Bar (0-100%)
â”‚   â”‚   â””â”€â”€ Transaction History List
â”‚   â”‚
â”‚   â”œâ”€â”€ HistoryView.tsx (490 lines)
â”‚   â”‚   â”œâ”€â”€ Summary Stats Cards
â”‚   â”‚   â”œâ”€â”€ Tab Navigation (3 tabs)
â”‚   â”‚   â”œâ”€â”€ Bookings Table
â”‚   â”‚   â”œâ”€â”€ Transactions Table
â”‚   â”‚   â””â”€â”€ Payment Sessions Table
â”‚   â”‚
â”‚   â””â”€â”€ DisputeChatbot.tsx (520 lines)
â”‚       â”œâ”€â”€ Chat Interface (Messages)
â”‚       â”œâ”€â”€ Staking UI (User + Owner)
â”‚       â”œâ”€â”€ AI Resolution Display
â”‚       â”œâ”€â”€ Winner Announcement
â”‚       â””â”€â”€ Payout Details
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ parkingApi.ts
â”‚   â”‚   â””â”€â”€ API Client Functions
â”‚   â”‚
â”‚   â””â”€â”€ walletService.ts
â”‚       â””â”€â”€ Blockfrost Integration
â”‚
â””â”€â”€ lib/
    â””â”€â”€ utils.ts (shadcn helpers)
```

### Backend Components

```
/
â”œâ”€â”€ app.py (2,300+ lines)
â”‚   â”œâ”€â”€ Flask App Initialization
â”‚   â”œâ”€â”€ CORS Configuration
â”‚   â”œâ”€â”€ 15 API Endpoints
â”‚   â””â”€â”€ Agent Initialization
â”‚
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ Agent Registry
â”‚   â”‚
â”‚   â”œâ”€â”€ orchestrator.py (300+ lines)
â”‚   â”‚   â”œâ”€â”€ Workflow Coordination
â”‚   â”‚   â”œâ”€â”€ Gate Check Logic
â”‚   â”‚   â”œâ”€â”€ Session Management
â”‚   â”‚   â””â”€â”€ Gemini AI Integration
â”‚   â”‚
â”‚   â”œâ”€â”€ spot_finder.py (250+ lines)
â”‚   â”‚   â”œâ”€â”€ Spot Analysis
â”‚   â”‚   â”œâ”€â”€ Gemini AI Ranking (0-100)
â”‚   â”‚   â”œâ”€â”€ Distance Calculation
â”‚   â”‚   â””â”€â”€ Masumi Payment (0.3â‚³)
â”‚   â”‚
â”‚   â”œâ”€â”€ pricing_agent.py (200+ lines)
â”‚   â”‚   â”œâ”€â”€ Dynamic Pricing
â”‚   â”‚   â”œâ”€â”€ Demand Forecasting
â”‚   â”‚   â””â”€â”€ Gemini AI Analysis
â”‚   â”‚
â”‚   â”œâ”€â”€ route_optimizer.py (200+ lines)
â”‚   â”‚   â”œâ”€â”€ Navigation Generation
â”‚   â”‚   â””â”€â”€ Gemini AI Directions
â”‚   â”‚
â”‚   â”œâ”€â”€ payment_verifier.py (250+ lines)
â”‚   â”‚   â”œâ”€â”€ Fraud Detection (0-100)
â”‚   â”‚   â”œâ”€â”€ Transaction Validation
â”‚   â”‚   â””â”€â”€ Gemini AI Risk Analysis
â”‚   â”‚
â”‚   â”œâ”€â”€ security_guard.py (300+ lines)
â”‚   â”‚   â”œâ”€â”€ Session Monitoring (30s)
â”‚   â”‚   â”œâ”€â”€ Anomaly Detection
â”‚   â”‚   â”œâ”€â”€ Violation Checking
â”‚   â”‚   â””â”€â”€ Gemini AI Alerts
â”‚   â”‚
â”‚   â””â”€â”€ dispute_resolver.py (350+ lines)
â”‚       â”œâ”€â”€ Evidence Analysis
â”‚       â”œâ”€â”€ Bilateral Staking
â”‚       â”œâ”€â”€ Gemini AI Arbitration
â”‚       â””â”€â”€ Winner Determination
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ firebase_service.py (400+ lines)
â”‚   â”‚   â”œâ”€â”€ Connection Management
â”‚   â”‚   â”œâ”€â”€ Parking Spots CRUD
â”‚   â”‚   â”œâ”€â”€ Payment Sessions CRUD
â”‚   â”‚   â”œâ”€â”€ Booking Records
â”‚   â”‚   â””â”€â”€ Real-time Updates
â”‚   â”‚
â”‚   â”œâ”€â”€ gemini_service.py (200+ lines)
â”‚   â”‚   â”œâ”€â”€ API Client Wrapper
â”‚   â”‚   â”œâ”€â”€ Prompt Management
â”‚   â”‚   â”œâ”€â”€ Response Parsing
â”‚   â”‚   â””â”€â”€ Error Handling
â”‚   â”‚
â”‚   â””â”€â”€ masumi_service.py (300+ lines)
â”‚       â”œâ”€â”€ Agent Registration
â”‚       â”œâ”€â”€ Payment Distribution
â”‚       â”œâ”€â”€ Transaction Signing
â”‚       â””â”€â”€ Cardano Submission
â”‚
â””â”€â”€ secrets/
    â””â”€â”€ parkngo-firebase-adminsdk.json
```

---

## ðŸ”„ Data Flow Diagrams

### Book Slot Orchestration Flow

```
USER                  FRONTEND              BACKEND                 AGENTS                MASUMI              CARDANO
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚ Click "Book Slot"    â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚ POST /book-slot     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ Execute Orchestrator  â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚  STEP 1: SpotFinder   â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   Gemini AI Analysis  â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   (2-3 seconds)       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚ Register Payment    â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚ Submit TX (0.3â‚³)   â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚ TX Confirmed       â”‚
  â”‚                      â”‚                     â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                     â”‚ Result: spot_01       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚  STEP 2: VehicleDetector                    â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   Check Sensors       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   Validate Plate      â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚ Payment (0.2â‚³)      â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚ TX Confirmed       â”‚
  â”‚                      â”‚                     â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                     â”‚ Gate Check:           â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ âœ… vehicle_detected   â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ âœ… correct_vehicle    â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚  STEP 3: PaymentAgent â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   Create Session      â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚   in Firebase         â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚ Payment (0.4â‚³)      â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚ TX Confirmed       â”‚
  â”‚                      â”‚                     â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                     â”‚ Session: ps_001       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚  Response (JSON)    â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                     â”‚                    â”‚
  â”‚  Success Message     â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚  + Session ID        â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚  + TX Hashes (Ã—3)    â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚  + Total: 0.9â‚³       â”‚                     â”‚                       â”‚                     â”‚                    â”‚
  â”‚                      â”‚                     â”‚                       â”‚                     â”‚                    â”‚
```

### Real-Time Payment Tracking Flow

```
FRONTEND              BACKEND              FIREBASE             CARDANO
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Start Polling       â”‚                     â”‚                    â”‚
   â”‚ (every 2 seconds)   â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”œâ”€ GET /payment-      â”‚                     â”‚                    â”‚
   â”‚  session/{id}       â”‚                     â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
   â”‚                     â”‚ Query Session Data  â”‚                    â”‚
   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚                     â”‚ Current State:      â”‚                    â”‚
   â”‚                     â”‚ â€¢ minutes: 1        â”‚                    â”‚
   â”‚                     â”‚ â€¢ total_ada: 0.02   â”‚                    â”‚
   â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Response: 0.02â‚³     â”‚                     â”‚                    â”‚
   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Update Progress Bar â”‚                     â”‚                    â”‚
   â”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.83%  â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ â±ï¸ Wait 2 seconds    â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”œâ”€ GET /payment-      â”‚                     â”‚                    â”‚
   â”‚  session/{id}       â”‚                     â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                     â”‚ Current State:      â”‚                    â”‚
   â”‚                     â”‚ â€¢ minutes: 2        â”‚                    â”‚
   â”‚                     â”‚ â€¢ total_ada: 0.04   â”‚                    â”‚
   â”‚                     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚ Response: 0.04â‚³     â”‚                     â”‚                    â”‚
   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Update Progress Bar â”‚                     â”‚                    â”‚
   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 1.67%  â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Append TX to        â”‚                     â”‚ Submit Micro-TX    â”‚
   â”‚ History List        â”‚                     â”‚ (0.02â‚³)            â”‚
   â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚ â€¢ TX Hash           â”‚                     â”‚                    â”‚
   â”‚ â€¢ Amount: 0.02â‚³     â”‚                     â”‚                    â”‚
   â”‚ â€¢ CardanoScan Link  â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
   â”‚ Continue polling... â”‚                     â”‚                    â”‚
   â”‚                     â”‚                     â”‚                    â”‚
```

### Dispute Resolution Flow

```
USER              FRONTEND           BACKEND           DISPUTE AI        MASUMI           CARDANO
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ "I was           â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚  overcharged"     â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ POST /disputes/  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚      create      â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Create Dispute   â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Record           â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ Response:        â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ dispute_id       â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ Show "Stake      â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚  1.0 ADA" button  â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ Click "Stake"     â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ POST /disputes/  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚      {id}/stake  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ User Stake TX    â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚ Submit (1.0â‚³)   â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚ Confirmed       â”‚
  â”‚                   â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                   â”‚ âœ… User Staked   â”‚                  â”‚                â”‚                 â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ Wait 3 seconds... â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Owner Stake TX   â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ (simulated)      â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                   â”‚ âœ… Owner Staked  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ ðŸ’° Total: 2.0â‚³   â”‚                  â”‚                â”‚                 â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ Click "Resolve"   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ POST /disputes/  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚      {id}/resolveâ”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Invoke AI Agent  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚ Analyze:       â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚ â€¢ Payment logs â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚ â€¢ Timestamps   â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚ â€¢ Evidence     â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚ (3-5 seconds)  â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Result:          â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ â€¢ Winner: User   â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ â€¢ Confidence: 85%â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ â€¢ Reasoning      â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ Payout TX (2.0â‚³) â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                   â”‚                  â”‚ to Winner        â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                   â”‚ Response:        â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ â€¢ Winner: User   â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ â€¢ Payout: 2.0â‚³   â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ â€¢ TX Hash        â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                 â”‚
  â”‚ ðŸŽ‰ You Won!       â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ ðŸ’° +2.0â‚³          â”‚                  â”‚                  â”‚                â”‚                 â”‚
  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                  â”‚                â”‚                 â”‚
  â”‚                   â”‚                  â”‚                  â”‚                â”‚                 â”‚
```

---

## ðŸ¤– Agent Orchestration

### Agent Hierarchy

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ORCHESTRATOR AGENT    â”‚
                    â”‚  (Master Coordinator)   â”‚
                    â”‚  â€¢ Workflow Management  â”‚
                    â”‚  â€¢ Gate Checks          â”‚
                    â”‚  â€¢ Error Handling       â”‚
                    â”‚  â€¢ Gemini AI Planning   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚               â”‚               â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CORE AGENTS     â”‚  â”‚ MONITORING   â”‚  â”‚  SUPPORT    â”‚  â”‚  DISPUTE   â”‚
    â”‚                  â”‚  â”‚   AGENTS     â”‚  â”‚   AGENTS    â”‚  â”‚   AGENT    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ â€¢ SpotFinder     â”‚  â”‚ â€¢ Security   â”‚  â”‚ â€¢ Pricing   â”‚  â”‚ â€¢ Dispute  â”‚
    â”‚   (0.3â‚³)         â”‚  â”‚   Guard      â”‚  â”‚   Agent     â”‚  â”‚   Resolver â”‚
    â”‚                  â”‚  â”‚   (Monitor)  â”‚  â”‚   (Pricing) â”‚  â”‚   (AI      â”‚
    â”‚ â€¢ VehicleDetectorâ”‚  â”‚              â”‚  â”‚             â”‚  â”‚   Judge)   â”‚
    â”‚   (0.2â‚³)         â”‚  â”‚ â€¢ Payment    â”‚  â”‚ â€¢ Route     â”‚  â”‚   (0.5â‚³)   â”‚
    â”‚                  â”‚  â”‚   Verifier   â”‚  â”‚   Optimizer â”‚  â”‚            â”‚
    â”‚ â€¢ PaymentAgent   â”‚  â”‚   (Fraud)    â”‚  â”‚   (Nav)     â”‚  â”‚            â”‚
    â”‚   (0.4â‚³)         â”‚  â”‚              â”‚  â”‚             â”‚  â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                  â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   SHARED SERVICES           â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ â€¢ Gemini AI API             â”‚
                    â”‚ â€¢ Firebase RTDB             â”‚
                    â”‚ â€¢ Masumi Payment Service    â”‚
                    â”‚ â€¢ Blockfrost API            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Agent Responsibilities Matrix

| Agent | Primary Function | AI Model | Cost | Execution Time | Dependencies |
|-------|------------------|----------|------|----------------|--------------|
| **Orchestrator** | Workflow coordination, gate checks | Gemini 1.5 Flash | 0â‚³ | N/A | All agents |
| **SpotFinder** | Rank & select best spot | Gemini 1.5 Flash | 0.3â‚³ | 1-3s | Firebase, Masumi |
| **VehicleDetector** | Validate vehicle presence | Gemini 1.5 Flash | 0.2â‚³ | 0.5-2s | Firebase, Masumi |
| **PaymentAgent** | Create & manage payment session | Gemini 1.5 Flash | 0.4â‚³ | 0.3-1s | Firebase, Masumi |
| **PricingAgent** | Calculate dynamic pricing | Gemini 1.5 Flash | 0â‚³ | 1-2s | Firebase |
| **RouteOptimizer** | Generate navigation | Gemini 1.5 Flash | 0â‚³ | 1-2s | Gemini |
| **SecurityGuard** | Monitor sessions, detect fraud | Gemini 1.5 Flash | 0â‚³ | Continuous | Firebase |
| **DisputeResolver** | AI arbitration | Gemini 1.5 Flash | 0.5â‚³ | 3-7s | Firebase, Masumi |

---

## â›“ï¸ Blockchain Integration

### Cardano Transaction Flow

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  MASUMI PAYMENT     â”‚
                    â”‚     SERVICE         â”‚
                    â”‚   (Port 3001)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚  TX for    â”‚      â”‚  TX for    â”‚      â”‚  TX for    â”‚
    â”‚ SpotFinder â”‚      â”‚  Vehicle   â”‚      â”‚  Payment   â”‚
    â”‚   (0.3â‚³)   â”‚      â”‚  Detector  â”‚      â”‚   Agent    â”‚
    â”‚            â”‚      â”‚   (0.2â‚³)   â”‚      â”‚   (0.4â‚³)   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  TRANSACTION        â”‚
                   â”‚    BUILDER          â”‚
                   â”‚  â€¢ Input Selection  â”‚
                   â”‚  â€¢ Output Creation  â”‚
                   â”‚  â€¢ Fee Calculation  â”‚
                   â”‚  â€¢ Metadata Attach  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  TRANSACTION        â”‚
                   â”‚    SIGNING          â”‚
                   â”‚  â€¢ Wallet Key       â”‚
                   â”‚  â€¢ Signature Gen    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  BLOCKFROST API     â”‚
                   â”‚  â€¢ TX Submission    â”‚
                   â”‚  â€¢ Block Inclusion  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  CARDANO PREPROD    â”‚
                   â”‚    TESTNET          â”‚
                   â”‚  â€¢ Validation       â”‚
                   â”‚  â€¢ Confirmation     â”‚
                   â”‚  â€¢ On-chain Record  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  CARDANOSCAN        â”‚
                   â”‚    EXPLORER         â”‚
                   â”‚  â€¢ TX Tracking      â”‚
                   â”‚  â€¢ Public View      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Payment Distribution Logic

```python
# Example transaction structure
{
  "tx_builder": {
    "inputs": [
      {
        "tx_hash": "previous_tx_hash",
        "tx_index": 0,
        "amount": 10.0  # ADA
      }
    ],
    "outputs": [
      {
        "address": "addr_spot_finder...",
        "amount": 0.3,  # SpotFinder payment
        "metadata": {
          "agent": "SpotFinder",
          "service": "spot_recommendation",
          "confidence": 95
        }
      },
      {
        "address": "addr_vehicle_detector...",
        "amount": 0.2,  # VehicleDetector payment
        "metadata": {
          "agent": "VehicleDetector",
          "service": "vehicle_validation",
          "plate": "ABC123"
        }
      },
      {
        "address": "addr_payment_agent...",
        "amount": 0.4,  # PaymentAgent payment
        "metadata": {
          "agent": "PaymentAgent",
          "service": "session_management",
          "session_id": "ps_001_..."
        }
      },
      {
        "address": "change_address...",
        "amount": 9.05  # Change (10 - 0.9 - 0.05 fee)
      }
    ],
    "fee": 0.05,  # Network fee
    "metadata": {
      "booking_id": "bk_001",
      "user_id": "user_001",
      "timestamp": "2025-11-30T03:40:00Z"
    }
  }
}
```

---

## ðŸ’¾ Database Schema

### Firebase Realtime Database Structure

```
parkngo-ai-default-rtdb/
â”œâ”€â”€ parking_spots/
â”‚   â”œâ”€â”€ spot_01/
â”‚   â”‚   â”œâ”€â”€ id: "spot_01"
â”‚   â”‚   â”œâ”€â”€ name: "V01"
â”‚   â”‚   â”œâ”€â”€ status: "available" | "occupied"
â”‚   â”‚   â”œâ”€â”€ location: {lat: 40.7128, lng: -74.0060}
â”‚   â”‚   â”œâ”€â”€ price_per_hour: 1.2
â”‚   â”‚   â”œâ”€â”€ features: ["covered", "ev_charging"]
â”‚   â”‚   â””â”€â”€ last_updated: "2025-11-30T03:40:00Z"
â”‚   â”‚
â”‚   â”œâ”€â”€ spot_02/ ... spot_05/ (similar structure)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ bookings/
â”‚   â”œâ”€â”€ bk_001/
â”‚   â”‚   â”œâ”€â”€ booking_id: "bk_001"
â”‚   â”‚   â”œâ”€â”€ user_id: "user_001"
â”‚   â”‚   â”œâ”€â”€ spot_id: "spot_01"
â”‚   â”‚   â”œâ”€â”€ vehicle_id: "ABC123"
â”‚   â”‚   â”œâ”€â”€ start_time: "2025-11-30T03:40:00Z"
â”‚   â”‚   â”œâ”€â”€ end_time: null | "2025-11-30T05:40:00Z"
â”‚   â”‚   â”œâ”€â”€ duration_hours: 2.0
â”‚   â”‚   â”œâ”€â”€ total_cost_ada: 2.4
â”‚   â”‚   â”œâ”€â”€ agent_fees_ada: 0.9
â”‚   â”‚   â”œâ”€â”€ status: "active" | "completed" | "cancelled"
â”‚   â”‚   â”œâ”€â”€ payment_session_id: "ps_001_..."
â”‚   â”‚   â””â”€â”€ orchestration: {
â”‚   â”‚       step_1: {...}, step_2: {...}, step_3: {...}
â”‚   â”‚     }
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ payment_sessions/
â”‚   â”œâ”€â”€ ps_001_1701337200/
â”‚   â”‚   â”œâ”€â”€ session_id: "ps_001_1701337200"
â”‚   â”‚   â”œâ”€â”€ booking_id: "bk_001"
â”‚   â”‚   â”œâ”€â”€ user_id: "user_001"
â”‚   â”‚   â”œâ”€â”€ spot_id: "spot_01"
â”‚   â”‚   â”œâ”€â”€ start_time: "2025-11-30T03:40:00Z"
â”‚   â”‚   â”œâ”€â”€ rate_per_minute: 0.02
â”‚   â”‚   â”œâ”€â”€ minutes_elapsed: 5
â”‚   â”‚   â”œâ”€â”€ total_deducted_ada: 0.10
â”‚   â”‚   â”œâ”€â”€ status: "active" | "completed" | "paused"
â”‚   â”‚   â”œâ”€â”€ transactions: [
â”‚   â”‚   â”‚   {
â”‚   â”‚   â”‚     timestamp: "2025-11-30T03:41:00Z",
â”‚   â”‚   â”‚     amount_ada: 0.02,
â”‚   â”‚   â”‚     tx_hash: "3f8e9d2a...",
â”‚   â”‚   â”‚     cardanoscan_url: "https://..."
â”‚   â”‚   â”‚   },
â”‚   â”‚   â”‚   ...
â”‚   â”‚   â”‚ ]
â”‚   â”‚   â””â”€â”€ last_updated: "2025-11-30T03:45:00Z"
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ transactions/
â”‚   â”œâ”€â”€ tx_001/
â”‚   â”‚   â”œâ”€â”€ transaction_id: "tx_001"
â”‚   â”‚   â”œâ”€â”€ booking_id: "bk_001"
â”‚   â”‚   â”œâ”€â”€ user_id: "user_001"
â”‚   â”‚   â”œâ”€â”€ amount_ada: 0.3
â”‚   â”‚   â”œâ”€â”€ agent: "SpotFinder"
â”‚   â”‚   â”œâ”€â”€ tx_hash: "3f8e9d2a..."
â”‚   â”‚   â”œâ”€â”€ timestamp: "2025-11-30T03:40:05Z"
â”‚   â”‚   â”œâ”€â”€ status: "confirmed" | "pending" | "failed"
â”‚   â”‚   â””â”€â”€ cardanoscan_url: "https://..."
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ disputes/
â”‚   â”œâ”€â”€ dispute_12345/
â”‚   â”‚   â”œâ”€â”€ dispute_id: "dispute_12345"
â”‚   â”‚   â”œâ”€â”€ booking_id: "bk_001"
â”‚   â”‚   â”œâ”€â”€ user_id: "user_001"
â”‚   â”‚   â”œâ”€â”€ issue_description: "Overcharged..."
â”‚   â”‚   â”œâ”€â”€ requested_refund_ada: 1.2
â”‚   â”‚   â”œâ”€â”€ status: "investigating" | "staking" | "resolved"
â”‚   â”‚   â”œâ”€â”€ created_at: "2025-11-30T03:45:00Z"
â”‚   â”‚   â”œâ”€â”€ staking: {
â”‚   â”‚   â”‚   user: {amount: 1.0, tx_hash: "...", confirmed: true},
â”‚   â”‚   â”‚   owner: {amount: 1.0, tx_hash: "...", confirmed: true},
â”‚   â”‚   â”‚   total_pot: 2.0
â”‚   â”‚   â”‚ }
â”‚   â”‚   â”œâ”€â”€ resolution: {
â”‚   â”‚   â”‚   winner: "user",
â”‚   â”‚   â”‚   confidence: 85,
â”‚   â”‚   â”‚   reasoning: "AI analysis shows...",
â”‚   â”‚   â”‚   evidence: [...],
â”‚   â”‚   â”‚   resolved_at: "2025-11-30T03:50:00Z"
â”‚   â”‚   â”‚ }
â”‚   â”‚   â”œâ”€â”€ messages: [
â”‚   â”‚   â”‚   {sender: "user", text: "...", timestamp: "..."},
â”‚   â”‚   â”‚   {sender: "agent", text: "...", timestamp: "..."},
â”‚   â”‚   â”‚   ...
â”‚   â”‚   â”‚ ]
â”‚   â”‚   â””â”€â”€ payout: {
â”‚   â”‚       winner_receives: 2.0,
â”‚   â”‚       ai_fee: 0.5,
â”‚   â”‚       tx_hash: "...",
â”‚   â”‚       cardanoscan_url: "..."
â”‚   â”‚     }
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ monitoring/
    â”œâ”€â”€ active_sessions/
    â”‚   â””â”€â”€ {session_id}: {...}
    â”‚
    â””â”€â”€ security_logs/
        â””â”€â”€ {log_id}: {...}
```

### PostgreSQL Schemas (Masumi Services)

**Registry Database (Port 5432):**
```sql
-- Agents table
CREATE TABLE agents (
  agent_id VARCHAR(255) PRIMARY KEY,
  agent_name VARCHAR(255) NOT NULL,
  agent_type VARCHAR(100),
  payment_address TEXT NOT NULL,
  cost_per_call DECIMAL(10, 6),
  endpoint_url TEXT,
  status VARCHAR(50) DEFAULT 'active',
  registered_at TIMESTAMP DEFAULT NOW(),
  last_active TIMESTAMP
);

-- Services table
CREATE TABLE services (
  service_id SERIAL PRIMARY KEY,
  agent_id VARCHAR(255) REFERENCES agents(agent_id),
  service_name VARCHAR(255),
  description TEXT,
  api_endpoint TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**Payment Database (Port 5433):**
```sql
-- Payments table
CREATE TABLE payments (
  payment_id SERIAL PRIMARY KEY,
  from_address TEXT NOT NULL,
  to_address TEXT NOT NULL,
  amount_lovelace BIGINT NOT NULL,
  amount_ada DECIMAL(15, 6),
  tx_hash TEXT UNIQUE,
  agent_id VARCHAR(255),
  booking_id VARCHAR(255),
  status VARCHAR(50) DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT NOW(),
  confirmed_at TIMESTAMP
);

-- Payment distributions table
CREATE TABLE payment_distributions (
  distribution_id SERIAL PRIMARY KEY,
  booking_id VARCHAR(255),
  total_amount_ada DECIMAL(15, 6),
  distributions JSONB,  -- Array of {agent_id, amount, tx_hash}
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ðŸ”’ Security Architecture

### Authentication & Authorization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API REQUEST                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  CORS Middleware    â”‚
              â”‚  â€¢ Origin Check     â”‚
              â”‚  â€¢ Headers Validate â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Rate Limiting      â”‚
              â”‚  â€¢ 100 req/min      â”‚
              â”‚  â€¢ IP-based         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Input Validation   â”‚
              â”‚  â€¢ Type checking    â”‚
              â”‚  â€¢ Sanitization     â”‚
              â”‚  â€¢ Length limits    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  API Key Check      â”‚
              â”‚  (Gemini/Blockfrost)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Business Logic     â”‚
              â”‚  Execution          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Protection

**Encryption:**
- âœ… Firebase Admin SDK uses TLS
- âœ… Blockfrost API uses HTTPS
- âœ… Gemini API uses HTTPS
- âœ… Docker internal network isolation

**Secrets Management:**
```
secrets/
â”œâ”€â”€ parkngo-firebase-adminsdk.json  (Firebase private key)
â””â”€â”€ .env                             (API keys, not in repo)

Environment Variables:
- GEMINI_API_KEY (Google AI)
- BLOCKFROST_PROJECT_ID (Cardano)
- FIREBASE_DATABASE_URL
- MASUMI_ADMIN_KEY
- MASUMI_ENCRYPTION_KEY
```

---

## ðŸ³ Deployment Architecture

### Docker Compose Network

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              parkngo-network (Bridge Network)               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  parkngo-api    â”‚  â”‚  masumi-registryâ”‚  â”‚  masumi-   â”‚ â”‚
â”‚  â”‚  (Flask)        â”‚  â”‚  (Node.js)      â”‚  â”‚  payment   â”‚ â”‚
â”‚  â”‚  Port: 5000     â”‚  â”‚  Port: 3000     â”‚  â”‚  (Node.js) â”‚ â”‚
â”‚  â”‚  Health: âœ…     â”‚  â”‚  Health: âœ…     â”‚  â”‚  Port: 3001â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                  â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          Internal DNS Resolution                      â”‚ â”‚
â”‚  â”‚  â€¢ parkngo-api:5000                                   â”‚ â”‚
â”‚  â”‚  â€¢ masumi-registry-service:3000                       â”‚ â”‚
â”‚  â”‚  â€¢ masumi-payment-service:3001                        â”‚ â”‚
â”‚  â”‚  â€¢ masumi-postgres-registry:5432                      â”‚ â”‚
â”‚  â”‚  â€¢ masumi-postgres-payment:5433                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  postgres-   â”‚  â”‚  postgres-   â”‚  â”‚  payment-        â”‚ â”‚
â”‚  â”‚  registry    â”‚  â”‚  payment     â”‚  â”‚  monitor         â”‚ â”‚
â”‚  â”‚  Port: 5432  â”‚  â”‚  Port: 5433  â”‚  â”‚  (Background)    â”‚ â”‚
â”‚  â”‚  Health: âœ…  â”‚  â”‚  Health: âœ…  â”‚  â”‚  Health: âœ…      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

External Connections:
â”œâ”€â”€ Frontend (localhost:8080) â†’ API (localhost:5000)
â”œâ”€â”€ API â†’ Firebase RTDB (External)
â”œâ”€â”€ API â†’ Gemini API (External)
â”œâ”€â”€ Masumi â†’ Cardano Blockchain (External)
â””â”€â”€ Frontend â†’ CardanoScan (External)
```

### Container Resource Allocation

| Container | CPU | Memory | Disk | Auto-restart |
|-----------|-----|--------|------|--------------|
| parkngo-api | 1.0 | 1GB | 10GB | unless-stopped |
| masumi-registry | 0.5 | 512MB | 5GB | unless-stopped |
| masumi-payment | 0.5 | 512MB | 5GB | unless-stopped |
| postgres-registry | 0.5 | 256MB | 20GB | unless-stopped |
| postgres-payment | 0.5 | 256MB | 20GB | unless-stopped |
| payment-monitor | 0.3 | 256MB | 1GB | unless-stopped |

**Total Resources:** ~3.3 CPU cores, ~2.75GB RAM, ~61GB disk

---

**This architecture supports:**
- âœ… 10+ concurrent users
- âœ… 100+ bookings/day
- âœ… Real-time updates (2s latency)
- âœ… 99.9% uptime target
- âœ… Horizontal scaling ready

