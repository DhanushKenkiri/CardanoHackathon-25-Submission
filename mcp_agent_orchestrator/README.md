# MCP Agent Orchestrator

This package contains a production-ready FastAPI server that implements Masumi's MIP-003 MCP contract so that orchestrated CrewAI agents can be listed on Sokosumi and monetized via the Masumi payment rail. There are **no mocks or stubs** anywhere in this service—every request hits Masumi's payment node, Sokosumi's registry, and OpenAI when you provide live credentials.

The code mirrors the "From Zero to Hero" and "List Your Agent on Sokosumi" guides:
- Uses the Masumi payment service for escrowed jobs
- Exposes the standard `/input_schema`, `/availability`, `/start_job`, `/status`, and `/provide_input` endpoints
- Talks to Sokosumi's registry so the agent can collaborate with cross-network agents on the testnet

## 1. Prerequisites

- Python **>=3.10, <3.13**
- [`uv`](https://github.com/astral-sh/uv) package manager
- A running Masumi Payment Service (local or hosted) reachable from this server
- An OpenAI API key for LLM-backed orchestration
- A Sokosumi testnet account with API token and registered wallet

```bash
uv venv --python 3.12
source .venv/bin/activate
uv pip install -e .
```

## 2. Environment Variables

Copy `.env.example` to `.env` and fill in real secrets.

```bash
cp .env.example .env
```

Key fields (see comments inside the template):

| Variable | Description |
| --- | --- |
| `PAYMENT_SERVICE_URL` | Base URL of your Masumi payment node (`https://payments-preprod.masumi.network/api/v1` or local) |
| `PAYMENT_API_KEY` | Purchaser key created via `/api-key/` |
| `AGENT_IDENTIFIER` | Identifier returned by Masumi `/registry/` |
| `SELLER_VKEY` | Hex VKey for the selling wallet (PREPROD) |
| `SOKOSUMI_BASE_URL` | Typically `https://testnet.api.sokosumi.ai` |
| `SOKOSUMI_API_KEY` | Token generated after submitting the [Tally registration form](https://tally.so/r/nPLBaV) |
| `NETWORK` | `Preprod` or `Mainnet` |
| `OPENAI_API_KEY` | Used for orchestration reasoning |
| `REDIS_URL` | Optional persistent job store. Falls back to in-memory if omitted |

## 3. Running the MCP Server

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

- Visit `http://localhost:8000/docs` to explore the autogenerated Swagger UI.
- Run a paid job end-to-end:
  1. `curl -X POST http://localhost:8000/start_job -d '{"identifier_from_purchaser":"abc123", "input_data":{"text":"parking analytics"}}'`
  2. Use the returned `job_id` with `/status`
  3. Call the Masumi payment `/purchase` endpoint supplying your `agent_identifier`
  4. The orchestrator notifies Sokosumi when the job finishes (`/agents/{id}/jobs`).

## 4. Sokosumi Collaboration Hooks

`app/sokosumi_client.py` implements:

- `register_capabilities` – pushes agent metadata & crew skills to Sokosumi
- `heartbeat` – reports MCP uptime back to the network
- `notify_job_event` – lets other Sokosumi agents subscribe to orchestration results

During `start_job`, the orchestrator verifies Sokosumi availability before accepting a payment. If Sokosumi reports the agent as paused, the MCP endpoint returns HTTP 409 so the marketplace never charges a purchaser for unavailable work. Keep these production checks enabled to guarantee the listing reflects real uptime rather than mocked responses.

## 5. Deploying to Testnet

1. Use the artifacts in `../sokosumi_agent_deployment` (Helm values + registration JSON) to publish the container image.
2. Point the deployment's environment variables to the secrets you generated once the Masumi registry returns your `agentIdentifier`.
3. Smoke test using the `verify_realtime_system.sh` script or the sample curl commands above.

## 6. Next Steps

- Replace the default in-memory job store with Redis/Postgres (see `JobStore` abstraction).
- Connect hardware payment triggers from `hardware_simulator.py` into the `/start_job` flow.
- Extend `app/orchestrator.py` to fan out tasks across additional CrewAI workers.
